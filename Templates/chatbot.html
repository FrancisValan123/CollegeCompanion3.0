{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <!-- Header Card -->
        <div class="card shadow-lg mb-4 border-0">
            <div class="card-header bg-gradient-primary text-white py-3">
                <div class="d-flex align-items-center">
                    <div class="ai-avatar me-3">
                        <i class="fas fa-robot fa-2x"></i>
                    </div>
                    <div>
                        <h4 class="mb-0">CollegeCompanion AI Assistant</h4>
                        <small class="text-light opacity-75">Your smart campus companion - Powered by enhanced AI</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Main Chat Area -->
            <div class="col-lg-8">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body p-0">
                        <!-- Chat Container -->
                        <div id="chat-container" class="chat-container">
                            <div id="chat-messages" class="chat-messages">
                                <div class="welcome-message">
                                    <div class="d-flex align-items-start">
                                        <div class="ai-avatar-small me-2">
                                            <i class="fas fa-robot"></i>
                                        </div>
                                        <div class="message-content">
                                            <div class="message-bubble bot-message">
                                                <strong>ü§ñ AI Assistant:</strong> Hello {{ current_user.name }}! üëã I'm your enhanced CollegeCompanion AI. How can I help you today? Type 'help' for available commands or try the quick actions below!
                                            </div>
                                            <div class="message-time" id="welcome-time"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="quick-actions-container p-3 border-top">
                            <div class="mb-2">
                                <small class="text-muted fw-bold">Quick Actions:</small>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-sm btn-light quick-action" data-message="help">
                                    <i class="fas fa-question-circle me-1 text-primary"></i>Help Guide
                                </button>
                                <button class="btn btn-sm btn-light quick-action" data-message="how to mark attendance">
                                    <i class="fas fa-calendar-check me-1 text-success"></i>Mark Attendance
                                </button>
                                <button class="btn btn-sm btn-light quick-action" data-message="share notes">
                                    <i class="fas fa-file-upload me-1 text-warning"></i>Share Notes
                                </button>
                                <button class="btn btn-sm btn-light quick-action" data-message="post lost item">
                                    <i class="fas fa-search me-1 text-danger"></i>Lost Item
                                </button>
                                <button class="btn btn-sm btn-light quick-action" data-message="submit complaint">
                                    <i class="fas fa-comment-dots me-1 text-info"></i>Submit Complaint
                                </button>
                                <button class="btn btn-sm btn-light quick-action" data-message="my profile">
                                    <i class="fas fa-user me-1 text-secondary"></i>My Profile
                                </button>
                            </div>
                        </div>

                        <!-- Chat Input -->
                        <div class="chat-input-container p-3 bg-light">
                            <form id="chat-form">
                                <div class="input-group">
                                    <input type="text" id="user-message" class="form-control border-0 shadow-sm" 
                                           placeholder="Ask me anything about CollegeCompanion features..." required>
                                    <button type="submit" class="btn btn-primary px-3">
                                        <i class="fas fa-paper-plane me-1"></i> Send
                                    </button>
                                </div>
                                <div class="mt-2 d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <strong>Try:</strong> "help", "features", "how to mark attendance", "share notes"
                                    </small>
                                    <div class="typing-indicator d-none" id="typing-indicator">
                                        <span class="typing-dots">
                                            <span>.</span><span>.</span><span>.</span>
                                        </span>
                                        <small class="text-muted ms-1">AI is typing</small>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Features Overview -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-gradient-success text-white py-2">
                        <h6 class="mb-0"><i class="fas fa-rocket me-1"></i>üöÄ Quick Commands</h6>
                    </div>
                    <div class="card-body p-3">
                        <div class="row">
                            <div class="col-6">
                                <ul class="list-unstyled small mb-0">
                                    <li class="mb-1"><i class="fas fa-caret-right text-success me-1"></i>mark attendance</li>
                                    <li class="mb-1"><i class="fas fa-caret-right text-success me-1"></i>view attendance</li>
                                    <li class="mb-1"><i class="fas fa-caret-right text-success me-1"></i>add student</li>
                                    <li class="mb-1"><i class="fas fa-caret-right text-success me-1"></i>post lost item</li>
                                    <li class="mb-1"><i class="fas fa-caret-right text-success me-1"></i>browse found</li>
                                </ul>
                            </div>
                            <div class="col-6">
                                <ul class="list-unstyled small mb-0">
                                    <li class="mb-1"><i class="fas fa-caret-right text-success me-1"></i>submit complaint</li>
                                    <li class="mb-1"><i class="fas fa-caret-right text-success me-1"></i>share notes</li>
                                    <li class="mb-1"><i class="fas fa-caret-right text-success me-1"></i>contact teachers</li>
                                    <li class="mb-1"><i class="fas fa-caret-right text-success me-1"></i>my profile</li>
                                    <li class="mb-1"><i class="fas fa-caret-right text-success me-1"></i>features</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Features -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-gradient-info text-white py-2">
                        <h6 class="mb-0"><i class="fas fa-star me-1"></i>‚≠ê AI Features</h6>
                    </div>
                    <div class="card-body p-3">
                        <ul class="list-unstyled small mb-0">
                            <li class="mb-1"><i class="fas fa-check-circle text-success me-1"></i>Personalized responses</li>
                            <li class="mb-1"><i class="fas fa-check-circle text-success me-1"></i>Role-based assistance</li>
                            <li class="mb-1"><i class="fas fa-check-circle text-success me-1"></i>Context-aware help</li>
                            <li class="mb-1"><i class="fas fa-check-circle text-success me-1"></i>Quick action buttons</li>
                            <li class="mb-1"><i class="fas fa-check-circle text-success me-1"></i>File upload guidance</li>
                            <li class="mb-1"><i class="fas fa-check-circle text-success me-1"></i>System feature explanations</li>
                        </ul>
                    </div>
                </div>

                <!-- Role-based Tips -->
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-gradient-warning text-dark py-2">
                        <h6 class="mb-0"><i class="fas fa-lightbulb me-1"></i>üí° Tips for {{ current_user.role.title() }}s</h6>
                    </div>
                    <div class="card-body p-3">
                        {% if current_user.role == 'admin' %}
                        <p class="mb-2"><strong>As an Admin, you can:</strong></p>
                        <ul class="small mb-0">
                            <li class="mb-1"><i class="fas fa-cog text-primary me-1"></i>Manage all students and teachers</li>
                            <li class="mb-1"><i class="fas fa-comments text-info me-1"></i>Resolve complaints and moderate content</li>
                            <li class="mb-1"><i class="fas fa-chart-bar text-success me-1"></i>Generate attendance reports</li>
                            <li class="mb-1"><i class="fas fa-shield-alt text-warning me-1"></i>Access complete system control</li>
                        </ul>
                        {% elif current_user.role == 'teacher' %}
                        <p class="mb-2"><strong>As a Teacher, you can:</strong></p>
                        <ul class="small mb-0">
                            <li class="mb-1"><i class="fas fa-calendar-check text-success me-1"></i>Mark daily attendance for students</li>
                            <li class="mb-1"><i class="fas fa-file-alt text-primary me-1"></i>Share study materials and notes</li>
                            <li class="mb-1"><i class="fas fa-users text-info me-1"></i>Communicate with students and staff</li>
                            <li class="mb-1"><i class="fas fa-chalkboard-teacher text-warning me-1"></i>Access teacher-specific features</li>
                        </ul>
                        {% else %}
                        <p class="mb-2"><strong>As a Student, you can:</strong></p>
                        <ul class="small mb-0">
                            <li class="mb-1"><i class="fas fa-chart-line text-info me-1"></i>View your attendance records</li>
                            <li class="mb-1"><i class="fas fa-book text-primary me-1"></i>Share and download study notes</li>
                            <li class="mb-1"><i class="fas fa-search text-warning me-1"></i>Post lost/found items</li>
                            <li class="mb-1"><i class="fas fa-comment text-danger me-1"></i>Submit anonymous complaints</li>
                            <li class="mb-1"><i class="fas fa-user-friends text-success me-1"></i>Communicate with peers and teachers</li>
                        </ul>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Custom CSS Variables */
:root {
    --primary-gradient: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
    --success-gradient: linear-gradient(135deg, #1cc88a 0%, #13855c 100%);
    --info-gradient: linear-gradient(135deg, #36b9cc 0%, #258391 100%);
    --warning-gradient: linear-gradient(135deg, #f6c23e 0%, #dda20a 100%);
}

/* Card Header Gradients */
.bg-gradient-primary {
    background: var(--primary-gradient);
}

.bg-gradient-success {
    background: var(--success-gradient);
}

.bg-gradient-info {
    background: var(--info-gradient);
}

.bg-gradient-warning {
    background: var(--warning-gradient);
}

/* AI Avatar */
.ai-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
}

.ai-avatar-small {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    border: 1px solid #e9ecef;
}

/* Chat Container */
.chat-container {
    height: 400px;
    overflow-y: auto;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px 8px 0 0;
}

.chat-messages {
    display: flex;
    flex-direction: column;
}

/* Message Styles */
.message-content {
    max-width: 80%;
    margin-bottom: 15px;
}

.message-bubble {
    padding: 12px 16px;
    border-radius: 18px;
    word-wrap: break-word;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.user-message {
    background: var(--primary-gradient);
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 4px;
}

.bot-message {
    background: white;
    color: #333;
    border: 1px solid #e9ecef;
    margin-right: auto;
    border-bottom-left-radius: 4px;
}

.message-time {
    font-size: 0.75rem;
    opacity: 0.7;
    margin-top: 5px;
    text-align: right;
}

.user-message .message-time {
    text-align: right;
}

.bot-message .message-time {
    text-align: left;
}

/* Quick Actions */
.quick-actions-container {
    background: white;
}

.quick-action {
    transition: all 0.2s ease;
    border-radius: 20px;
    border: 1px solid #e9ecef;
}

.quick-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Chat Input */
.chat-input-container {
    border-radius: 0 0 8px 8px;
}

#user-message {
    border-radius: 20px;
    padding: 12px 20px;
}

/* Typing Indicator */
.typing-indicator {
    display: flex;
    align-items: center;
}

.typing-dots {
    display: inline-flex;
}

.typing-dots span {
    animation: typing 1.4s infinite ease-in-out;
    margin: 0 1px;
}

.typing-dots span:nth-child(1) { animation-delay: 0s; }
.typing-dots span:nth-child(2) { animation-delay: 0.2s; }
.typing-dots span:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-5px); }
}

/* Scrollbar Styling */
.chat-container::-webkit-scrollbar {
    width: 6px;
}

.chat-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.chat-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
}

.chat-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Welcome Message */
.welcome-message {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Responsive Adjustments */
@media (max-width: 768px) {
    .message-content {
        max-width: 90%;
    }
    
    .chat-container {
        height: 350px;
        padding: 15px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-message');
    const chatMessages = document.getElementById('chat-messages');
    const chatContainer = document.getElementById('chat-container');
    const typingIndicator = document.getElementById('typing-indicator');
    const welcomeTime = document.getElementById('welcome-time');

    // Set current time for welcome message
    if (welcomeTime) {
        welcomeTime.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    // Quick action buttons
    document.querySelectorAll('.quick-action').forEach(button => {
        button.addEventListener('click', function() {
            const message = this.getAttribute('data-message');
            userInput.value = message;
            chatForm.dispatchEvent(new Event('submit'));
        });
    });

    // Chat form submission
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const message = userInput.value.trim();
        if (!message) return;

        // Add user message to chat
        addMessageToChat('üë§ You', message, 'user');
        userInput.value = '';

        // Show typing indicator
        typingIndicator.classList.remove('d-none');

        // Send to server
        fetch('{{ url_for("chatbot") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'message=' + encodeURIComponent(message)
        })
        .then(response => response.json())
        .then(data => {
            // Hide typing indicator
            typingIndicator.classList.add('d-none');
            
            // Format bot response with line breaks
            const formattedResponse = data.response.replace(/\n/g, '<br>');
            addMessageToChat('ü§ñ AI Assistant', formattedResponse, 'bot');
        })
        .catch(error => {
            // Hide typing indicator
            typingIndicator.classList.add('d-none');
            addMessageToChat('ü§ñ AI Assistant', 'Sorry, I encountered an error. Please try again.', 'bot');
        });
    });

    function addMessageToChat(sender, message, type) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `d-flex align-items-start ${type === 'user' ? 'justify-content-end' : ''}`;
        
        const currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        let avatarHtml = '';
        if (type === 'bot') {
            avatarHtml = '<div class="ai-avatar-small me-2"><i class="fas fa-robot"></i></div>';
        }
        
        messageDiv.innerHTML = `
            ${type === 'bot' ? avatarHtml : ''}
            <div class="message-content">
                <div class="message-bubble ${type}-message">
                    ${message}
                </div>
                <div class="message-time">${currentTime}</div>
            </div>
            ${type === 'user' ? avatarHtml : ''}
        `;
        
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
        
        // Add animation for new messages
        messageDiv.style.opacity = '0';
        messageDiv.style.transform = 'translateY(10px)';
        
        setTimeout(() => {
            messageDiv.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            messageDiv.style.opacity = '1';
            messageDiv.style.transform = 'translateY(0)';
        }, 10);
    }

    function scrollToBottom() {
        chatContainer.scrollTo({
            top: chatContainer.scrollHeight,
            behavior: 'smooth'
        });
    }

    // Auto-focus on input
    userInput.focus();

    // Enter key to send message
    userInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            chatForm.dispatchEvent(new Event('submit'));
        }
    });

    // Auto-scroll when new messages are added
    const observer = new MutationObserver(scrollToBottom);
    observer.observe(chatMessages, { childList: true });
});
</script>
{% endblock %}